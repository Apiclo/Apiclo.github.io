<!DOCTYPE html>
<html>
<head>
    <style>
        .card { padding: 15px; margin: 10px; border: 1px solid #ddd; border-radius: 8px }
        .status-indicator {
            width: 12px; height: 12px; border-radius: 50%; display: inline-block;
            margin-left: 10px;
        }
        .loading { background: #ffd700; animation: pulse 1.5s infinite }
        .success { background: #32cd32 }
        .error { background: #dc143c }
        @keyframes pulse {
            0% { opacity: 1 }
            50% { opacity: 0.4 }
            100% { opacity: 1 }
        }
    </style>
</head>
<body>
    <div class="card">
        <h3>服务器信息</h3>
        <div>IPv4: <span id="server-ipv4">-</span><span class="status-indicator"></span></div>
        <div>IPv6: <span id="server-ipv6">-</span><span class="status-indicator"></span></div>
    </div>
    
    <div class="card">
        <h3>客户端信息</h3>
        <div>IP地址: <span id="client-ip">-</span></div>
        <div>连接类型: <span id="connection-type">-</span></div>
    </div>

<script>
// 配置参数
const CONFIG = {
    DOH_PROVIDERS: [
        'https://cloudflare-dns.com/dns-query',
        'https://dns.google/resolve',
        'https://doh.opendns.com/dns-query'
    ],
    IP_API_PROVIDERS: [
        'https://api.ipify.org?format=json',
        'https://ipv4.icanhazip.com/',
        'https://ipv6.icanhazip.com/'
    ],
    RETRY_TIMES: 2
};

// 增强版DNS查询
async function getDNSRecords(domain, type = 'A') {
    const recordType = type === 'A' ? 1 : 28;
    
    for (const endpoint of CONFIG.DOH_PROVIDERS) {
        for (let attempt = 0; attempt < CONFIG.RETRY_TIMES; attempt++) {
            try {
                const url = `${endpoint}?name=${domain}&type=${type}`;
                const response = await fetch(url, {
                    headers: { 'Accept': 'application/dns-json' }
                });

                if (!response.ok) continue;
                
                const data = await response.json();
                const answers = data.Answer || data.answers || [];
                
                // 过滤并提取有效记录
                const records = answers
                    .filter(r => r.type === recordType)
                    .map(r => r.data.replace(/\.$/, ''));  // 处理尾部点号

                if (records.length > 0) return records;
            } catch (error) {
                console.debug(`DNS查询尝试失败 [${endpoint}]:`, {
                    error: error.message,
                    type,
                    attempt: attempt + 1
                });
            }
        }
    }
    return [];
}

// 状态更新工具函数
function updateStatus(elementId, values, statusElement) {
    const container = document.getElementById(elementId);
    const status = statusElement ? container.nextElementSibling : null;
    
    if (values.length > 0) {
        container.innerHTML = values.join('<br>');
        status?.classList.add('success');
        status?.classList.remove('error', 'loading');
    } else {
        container.textContent = `未找到${elementId.includes('ipv6') ? 'IPv6' : 'IPv4'}记录`;
        status?.classList.add('error');
        status?.classList.remove('success', 'loading');
    }
}

// 服务器信息查询
async function showDNSInfo() {
    const currentDomain = window.location.hostname;
    
    try {
        // 并行查询优化
        const [ipv4List, ipv6List] = await Promise.all([
            getDNSRecords(currentDomain, 'A'),
            getDNSRecords(currentDomain, 'AAAA')
        ]);

        updateStatus('server-ipv4', ipv4List, true);
        updateStatus('server-ipv6', ipv6List, true);
    } catch (error) {
        console.error('DNS全局查询失败:', error);
        updateStatus('server-ipv4', []);
        updateStatus('server-ipv6', []);
    }
}

// 增强版客户端IP获取
async function getClientIP() {
    const fallback = () => {
        document.getElementById('client-ip').textContent = '获取失败';
        document.getElementById('connection-type').textContent = '未知';
    };

    try {
        for (const api of CONFIG.IP_API_PROVIDERS) {
            try {
                const response = await fetch(api);
                const data = await response.text();
                
                // 统一处理不同响应格式
                const ip = data.startsWith('{') 
                    ? JSON.parse(data).ip 
                    : data.trim();

                if (validateIP(ip)) {
                    document.getElementById('client-ip').textContent = ip;
                    document.getElementById('connection-type').textContent = 
                        ip.includes(':') ? 'IPv6' : 'IPv4';
                    return;
                }
            } catch (error) {
                console.debug(`IP API失败 [${api}]:`, error.message);
            }
        }
        fallback();
    } catch (error) {
        console.error('IP查询全局失败:', error);
        fallback();
    }
}

// IP验证函数
function validateIP(ip) {
    return /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/.test(ip) ||  // IPv4
           /^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/.test(ip);  // IPv6
}

// 初始化
window.addEventListener('load', () => {
    // 显示加载状态
    document.querySelectorAll('.status-indicator').forEach(el => {
        el.classList.add('loading');
    });
    
    showDNSInfo();
    getClientIP();
});
</script>
</body>
</html>