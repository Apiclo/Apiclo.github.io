<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>网络连接状态检测</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; margin: 0; padding: 2em; display: flex; justify-content: center; }
        .container { max-width: 600px; width: 100%; }
        .card { background: white; border-radius: 10px; padding: 1.5em; margin: 1em; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .status-item { margin: 1em 0; }
        .ip-label { font-weight: bold; color: #2c3e50; }
        .loading { color: #7f8c8d; font-style: italic; }
        .error { color: #e74c3c; }
        .success { color: #27ae60; }
    </style>
</head>
<body>
    <div class="container">
        <!-- IPv4 检测卡片 -->
        <div class="card">
            <h2>IPv4 连接状态</h2>
            <div class="status-item">
                <span class="ip-label">解析地址：</span>
                <span id="ipv4-status" class="loading">检测中...</span>
            </div>
        </div>

        <!-- IPv6 检测卡片 -->
        <div class="card">
            <h2>IPv6 连接状态</h2>
            <div class="status-item">
                <span class="ip-label">解析地址：</span>
                <span id="ipv6-status" class="loading">检测中...</span>
            </div>
        </div>

        <!-- 客户端信息卡片 -->
        <div class="card">
            <h2>客户端信息</h2>
            <div class="status-item">
                <span class="ip-label">公网IP：</span>
                <span id="client-ip" class="loading">检测中...</span>
            </div>
            <div class="status-item">
                <span class="ip-label">连接类型：</span>
                <span id="connection-type" class="loading">检测中...</span>
            </div>
        </div>
    </div>

<script>
// 更新客户端IP检测模块
async function detectClientIP() {
    const API_LIST = [
        {
            url: 'https://speed.neu6.edu.cn/getIP.php',
            parser: text => text.match(/(\d+\.\d+\.\d+\.\d+)/)?.[0]
        },
        {
            url: 'https://www.ipplus360.com/getIP',
            parser: text => text.match(/((?:\d{1,3}\.){3}\d{1,3})/)?.[0]
        },
        {
            url: 'https://www.cip.cc/',
            parser: text => text.match(/IP\s+:\s+(\d+\.\d+\.\d+\.\d+)/)?.[1]
        },
        {
            url: 'https://myip4.ipip.net',
            parser: text => text.match(/(\d+\.\d+\.\d+\.\d+)/)?.[0]
        }
    ];

    // 新增WebRTC备选方案
    const fallbackIP = await getLocalIP().catch(() => null);

    for (const api of API_LIST) {
        try {
            const response = await fetch(api.url, {
                mode: 'no-cors',
                headers: { 'Cache-Control': 'no-cache' }
            });
            
            if (!response.ok) continue;
            const text = await response.text();
            const ip = api.parser(text);
            
            if (ip && this.validateIP(ip)) {
                this.updateClientInfo(ip);
                return;
            }
        } catch (e) { continue; }
    }

    // 所有API失败时显示本地IP
    this.updateClientInfo(fallbackIP || '未知', !!fallbackIP);
}

// IP格式验证
validateIP(ip) {
    return /^(?:\d{1,3}\.){3}\d{1,3}$/.test(ip) || 
           /^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/.test(ip);
}

// WebRTC获取本地IP
async function getLocalIP() {
    return new Promise((resolve, reject) => {
        const pc = new RTCPeerConnection({ iceServers: [] });
        pc.createDataChannel('');
        pc.createOffer().then(sdp => pc.setLocalDescription(sdp));
        
        pc.onicecandidate = ice => {
            if (!ice.candidate) return;
            const ip = ice.candidate.address.match(/(\d+\.\d+\.\d+\.\d+)/)?.[0];
            if (ip) resolve(ip);
            pc.close();
        };
        
        setTimeout(() => reject(new Error('Timeout')), 1000);
    });
}

// 更新显示逻辑
updateClientInfo(ip, isValid = false) {
    const ipElement = document.getElementById('client-ip');
    const typeElement = document.getElementById('connection-type');
    
    if (isValid) {
        ipElement.textContent = ip;
        ipElement.className = 'success';
        typeElement.textContent = ip.includes(':') ? 'IPv6' : 'IPv4';
        typeElement.className = 'success';
    } else {
        ipElement.textContent = '检测失败';
        ipElement.className = 'error';
        typeElement.textContent = '未知';
        typeElement.className = 'error';
    }
}
</script>
</body>
</html>