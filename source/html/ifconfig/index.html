<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>网络连接信息</title>
    <style>
        /* 保持原有样式不变 */
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 2em; }
        .container { width: 100%; max-width: 600px; }
        .card { background: white; border-radius: 15px; padding: 1em; margin: 1em; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card h3 { color: #333; margin-top: 0; }
        .card p { color: #666; margin: 0.5em 0; }
        .ip-label { font-weight: bold; color: #444; }
        .dns-type { font-size: 0.9em; color: #888; }
        .loading { color: #999; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h3>域名解析信息</h3>
            <p><span class="ip-label">当前域名:</span> <span id="current-domain">加载中...</span></p>
            <p><span class="ip-label">解析IP地址:</span> 
                <span id="server-ip">
                    <div class="loading">正在查询DNS记录...</div>
                </span>
            </p>
        </div>

        <div class="card">
            <h3>客户端信息</h3>
            <p><span class="ip-label">客户端IP:</span> <span id="client-ip">检测中...</span></p>
        </div>

        <div class="card">
            <h3>连接类型</h3>
            <p><span class="ip-label">IP 版本:</span> <span id="connection-type">检测中...</span></p>
        </div>
    </div>

    <script>
        // 获取当前访问域名
        const currentDomain = window.location.hostname;
        document.getElementById('current-domain').textContent = currentDomain;

        // 使用国内DNS API（腾讯云DNSPod）
        async function getDNSRecords(domain, type = 'A') {
            try {
                const response = await fetch(
                    `https://doh.pub/dns-query?name=${domain}&type=${type}`,
                    {
                        headers: {
                            'Accept': 'application/dns-json'
                        }
                    }
                );
                
                if (!response.ok) throw new Error('DNS查询失败');
                const data = await response.json();
                
                // 解析DNSPod返回格式
                return data.Answer ? data.Answer.map(record => record.data) : [];
            } catch (error) {
                console.error(`DNS ${type}记录查询失败:`, error);
                return [];
            }
        }

        // 显示DNS解析结果（优化国内访问）
        async function showDNSInfo() {
            const ipContainer = document.getElementById('server-ip');
            ipContainer.innerHTML = '<div class="loading">正在查询DNS记录...</div>';

            try {
                // 并行查询A和AAAA记录
                const [ipv4List, ipv6List] = await Promise.all([
                    getDNSRecords(currentDomain, 'A'),
                    getDNSRecords(currentDomain, 'AAAA')
                ]);

                ipContainer.innerHTML = ''; // 清空加载状态

                // 显示IPv4地址
                if (ipv4List.length > 0) {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        ${ipv4List.join(', ')}
                        <span class="dns-type">(A记录)</span>
                    `;
                    ipContainer.appendChild(div);
                }

                // 显示IPv6地址
                if (ipv6List.length > 0) {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        ${ipv6List.join(', ')}
                        <span class="dns-type">(AAAA记录)</span>
                    `;
                    ipContainer.appendChild(div);
                }

                if (!ipv4List.length && !ipv6List.length) {
                    ipContainer.innerHTML = '未找到解析记录';
                }

            } catch (error) {
                console.error('DNS信息获取失败:', error);
                ipContainer.innerHTML = 'DNS查询失败';
            }
        }

        // 使用国内IP检测服务
        async function getClientIP() {
            try {
                // 同时使用多个国内IP检测服务
                const responses = await Promise.allSettled([
                    fetch('https://www.taobao.com/help/getip.php'),
                    fetch('https://ip.3322.net/')
                ]);

                // 处理淘宝IP服务
                let taobaoIP = null;
                if (responses[0].status === 'fulfilled') {
                    const text = await responses[0].value.text();
                    const match = text.match(/"ip":"(\d+\.\d+\.\d+\.\d+)"/);
                    taobaoIP = match ? match[1] : null;
                }

                // 处理3322 IP服务
                let ip3322 = null;
                if (responses[1].status === 'fulfilled') {
                    ip3322 = await responses[1].value.text();
                }

                // 优先显示淘宝IP，其次3322
                const clientIP = taobaoIP || ip3322 || '未知';
                document.getElementById('client-ip').textContent = clientIP;

                // 检测IP类型
                document.getElementById('connection-type').textContent = 
                    clientIP.includes(':') ? 'IPv6' : 'IPv4';

            } catch (error) {
                console.error('客户端信息获取失败:', error);
                document.getElementById('client-ip').textContent = '获取失败';
                document.getElementById('connection-type').textContent = '检测失败';
            }
        }

        // 页面加载时执行
        window.addEventListener('load', () => {
            getClientIP();
            showDNSInfo();
        });
    </script>
</body>
</html>