<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络信息仪表盘</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --error: #e74c3c;
            --warning: #f1c40f;
            --background: #f5f6fa;
            --text: #2c3e50;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--background);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: 24px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .status-group {
            display: flex;
            gap: 8px;
        }

        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
        }

        .status-indicator.loading {
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }

        .status-indicator.success {
            background: var(--success);
        }

        .status-indicator.error {
            background: var(--error);
        }

        .ip-section {
            margin: 16px 0;
        }

        .ip-section h3 {
            color: var(--secondary);
            margin: 0 0 12px 0;
            font-size: 1.1em;
        }

        .ip-list pre {
            background: var(--background);
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .info-grid {
            display: grid;
            gap: 16px;
        }

        .info-item label {
            display: block;
            color: #7f8c8d;
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .connection-badge {
            background: var(--secondary);
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            display: inline-block;
            font-size: 0.9em;
        }

        .ipv6-item {
            transition: opacity 0.3s ease;
        }

        @keyframes pulse {
            0% { opacity: 1 }
            50% { opacity: 0.4 }
            100% { opacity: 1 }
        }

        @media (max-width: 600px) {
            body {
                padding: 12px;
            }
            
            .card {
                padding: 18px;
            }

            .info-item {
                grid-column: 1 / -1;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="card server-card">
            <div class="card-header">
                <h2>服务器信息</h2>
                <div class="status-group">
                    <span class="status-indicator loading" data-type="ipv4"></span>
                    <span class="status-indicator loading" data-type="ipv6"></span>
                </div>
            </div>
            <div class="ip-section">
                <h3>IPv4 地址</h3>
                <div id="server-ipv4-list" class="ip-list"></div>
            </div>
            <div class="ip-section">
                <h3>IPv6 地址</h3>
                <div id="server-ipv6-list" class="ip-list"></div>
            </div>
        </div>

        <div class="card client-card">
            <div class="card-header">
                <h2>客户端信息</h2>
                <span class="status-indicator loading" data-type="client"></span>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <label>IPv4 地址</label>
                    <pre id="client-ipv4">-</pre>
                </div>
                <div class="info-item ipv6-item" style="display: none;">
                    <label>IPv6 地址</label>
                    <pre id="client-ipv6">-</pre>
                </div>
                <div class="info-item">
                    <label>连接类型</label>
                    <div id="connection-type" class="connection-badge">-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 配置参数
        const CONFIG = {
            DOH_PROVIDERS: [
                'https://cloudflare-dns.com/dns-query',
                'https://dns.google/resolve',
                'https://doh.opendns.com/dns-query'
            ],
            IP_API_PROVIDERS: {
                ipv4: [
                    'https://api.ipify.org?format=json',
                    'https://ipv4.icanhazip.com/'
                ],
                ipv6: [
                    'https://api6.ipify.org?format=json',
                    'https://ipv6.icanhazip.com/'
                ]
            },
            RETRY_TIMES: 2
        };

        // 状态管理对象
        const StatusManager = {
            setStatus: (type, status) => {
                const indicator = document.querySelector(`.status-indicator[data-type="${type}"]`);
                if (indicator) {
                    indicator.className = `status-indicator ${status}`;
                }
            },
            
            setClientStatus: (status) => {
                StatusManager.setStatus('client', status);
            }
        };

        // DNS记录查询
        async function getDNSRecords(domain, type = 'A') {
            const recordType = type === 'A' ? 1 : 28;
            
            for (const endpoint of CONFIG.DOH_PROVIDERS) {
                for (let attempt = 0; attempt < CONFIG.RETRY_TIMES; attempt++) {
                    try {
                        const url = `${endpoint}?name=${domain}&type=${type}`;
                        const response = await fetch(url, {
                            headers: { 'Accept': 'application/dns-json' }
                        });

                        if (!response.ok) continue;
                        
                        const data = await response.json();
                        const answers = data.Answer || data.answers || [];
                        
                        return answers
                            .filter(r => r.type === recordType)
                            .map(r => r.data.replace(/\.$/, ''));
                    } catch (error) {
                        console.debug(`DNS查询失败 [${endpoint}]:`, error.message);
                    }
                }
            }
            return [];
        }

        // 更新IP显示
        function updateIPDisplay(containerId, values, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (values.length > 0) {
                values.forEach(ip => {
                    const pre = document.createElement('pre');
                    pre.textContent = ip;
                    container.appendChild(pre);
                });
                StatusManager.setStatus(type, 'success');
            } else {
                const error = document.createElement('div');
                error.className = 'ip-error';
                error.textContent = `未找到${type.toUpperCase()}记录`;
                container.appendChild(error);
                StatusManager.setStatus(type, 'error');
            }
        }

        // 获取服务器信息
        async function showDNSInfo() {
            const currentDomain = window.location.hostname;
            
            try {
                const [ipv4List, ipv6List] = await Promise.all([
                    getDNSRecords(currentDomain, 'A'),
                    getDNSRecords(currentDomain, 'AAAA')
                ]);

                updateIPDisplay('server-ipv4-list', ipv4List, 'ipv4');
                updateIPDisplay('server-ipv6-list', ipv6List, 'ipv6');
            } catch (error) {
                console.error('DNS查询失败:', error);
                updateIPDisplay('server-ipv4-list', [], 'ipv4');
                updateIPDisplay('server-ipv6-list', [], 'ipv6');
            }
        }

        // IP验证函数
        function validateIP(ip) {
            return /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/.test(ip) || 
                   /^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/.test(ip);
        }

        // 新增IP获取方法
        async function fetchIP(type) {
            const endpoints = CONFIG.IP_API_PROVIDERS[type];
            for (const endpoint of endpoints) {
                for (let attempt = 0; attempt < CONFIG.RETRY_TIMES; attempt++) {
                    try {
                        const response = await fetch(endpoint);
                        if (!response.ok) continue;
                        
                        const data = await response.text();
                        const ip = data.startsWith('{') 
                            ? JSON.parse(data).ip 
                            : data.trim();

                        if (validateIP(ip)) {
                            return ip;
                        }
                    } catch (error) {
                        console.debug(`${type} API请求失败 [${endpoint}]:`, error.message);
                    }
                }
            }
            return null;
        }

        // 修改客户端信息获取逻辑
        async function getClientIP() {
            try {
                const [ipv4Result, ipv6Result] = await Promise.allSettled([
                    fetchIP('ipv4'),
                    fetchIP('ipv6')
                ]);

                const ipv4 = ipv4Result.status === 'fulfilled' ? ipv4Result.value : null;
                const ipv6 = ipv6Result.status === 'fulfilled' ? ipv6Result.value : null;

                // 更新显示
                document.getElementById('client-ipv4').textContent = ipv4 || '未检测到';
                document.getElementById('client-ipv6').textContent = ipv6 || '未检测到';
                
                // 控制IPv6显示
                const ipv6Item = document.querySelector('.ipv6-item');
                ipv6Item.style.display = ipv6 ? 'block' : 'none';

                // 更新连接类型
                let connectionType = '未知';
                if (ipv4 && ipv6) {
                    connectionType = '双栈网络';
                } else if (ipv4) {
                    connectionType = 'IPv4';
                } else if (ipv6) {
                    connectionType = 'IPv6';
                }
                document.getElementById('connection-type').textContent = connectionType;

                // 更新状态
                StatusManager.setClientStatus(ipv4 || ipv6 ? 'success' : 'error');
            } catch (error) {
                console.error('客户端信息获取失败:', error);
                StatusManager.setClientStatus('error');
            }
        }

        // 初始化
        window.addEventListener('load', () => {
            showDNSInfo();
            getClientIP();
        });
    </script>
</body>
</html>