<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>网络连接状态检测</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; margin: 0; padding: 2em; display: flex; justify-content: center; }
        .container { max-width: 600px; width: 100%; }
        .card { background: white; border-radius: 10px; padding: 1.5em; margin: 1em; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .status-item { margin: 1em 0; }
        .ip-label { font-weight: bold; color: #2c3e50; }
        .loading { color: #7f8c8d; font-style: italic; }
        .error { color: #e74c3c; }
        .success { color: #27ae60; }
    </style>
</head>
<body>
    <div class="container">
        <!-- IPv4 检测卡片 -->
        <div class="card">
            <h2>IPv4 连接状态</h2>
            <div class="status-item">
                <span class="ip-label">解析地址：</span>
                <span id="ipv4-status" class="loading">检测中...</span>
            </div>
        </div>

        <!-- IPv6 检测卡片 -->
        <div class="card">
            <h2>IPv6 连接状态</h2>
            <div class="status-item">
                <span class="ip-label">解析地址：</span>
                <span id="ipv6-status" class="loading">检测中...</span>
            </div>
        </div>

        <!-- 客户端信息卡片 -->
        <div class="card">
            <h2>客户端信息</h2>
            <div class="status-item">
                <span class="ip-label">公网IP：</span>
                <span id="client-ip" class="loading">检测中...</span>
            </div>
            <div class="status-item">
                <span class="ip-label">连接类型：</span>
                <span id="connection-type" class="loading">检测中...</span>
            </div>
        </div>
    </div>

<script>
// 国内可用API列表（2024最新）
const API_ENDPOINTS = {
    DNS: {
        v4: 'https://dns.alidns.com/resolve?name=',
        v6: 'https://dns.alidns.com/resolve?name='
    },
    IP: [
        'https://cip.cc/',
        'https://www.ip.cn/api/index?ip&type=0',
        'https://www.163.com/'
    ]
};

// 新版检测逻辑
class NetworkDetector {
    constructor() {
        this.domain = window.location.hostname;
    }

    async init() {
        await Promise.allSettled([
            this.checkIPv4(),
            this.checkIPv6(),
            this.detectClientIP()
        ]);
    }

    // IPv4检测（阿里DNS API）
    async checkIPv4() {
        try {
            const url = `${API_ENDPOINTS.DNS.v4}${this.domain}&type=A`;
            const response = await fetch(url, { 
                headers: { 'Accept': 'application/dns-json' }
            });
            
            if (!response.ok) throw new Error('DNS查询失败');
            const data = await response.json();
            
            this.updateStatus('ipv4', 
                data.Answer?.[0]?.data || '无记录', 
                data.Status === 0 ? 'success' : 'error'
            );
        } catch (e) {
            this.updateStatus('ipv4', `检测失败: ${e.message}`, 'error');
        }
    }

    // IPv6检测（阿里DNS API）
    async checkIPv6() {
        try {
            const url = `${API_ENDPOINTS.DNS.v6}${this.domain}&type=AAAA`;
            const response = await fetch(url, { 
                headers: { 'Accept': 'application/dns-json' }
            });
            
            if (!response.ok) throw new Error('DNS查询失败');
            const data = await response.json();
            
            this.updateStatus('ipv6', 
                data.Answer?.[0]?.data || '无记录', 
                data.Status === 0 ? 'success' : 'error'
            );
        } catch (e) {
            this.updateStatus('ipv6', `检测失败: ${e.message}`, 'error');
        }
    }

    // 客户端IP检测（多源冗余检测）
    async detectClientIP() {
        for (const endpoint of API_ENDPOINTS.IP) {
            try {
                const response = await fetch(endpoint);
                const text = await response.text();
                
                // 解析不同API的响应格式
                const ip = this.parseIPFromResponse(text);
                if (ip) {
                    this.updateClientInfo(ip);
                    return;
                }
            } catch (e) { continue; }
        }
        this.updateClientInfo('未知', true);
    }

    // 响应解析器（支持多个API格式）
    parseIPFromResponse(text) {
        // 匹配 cip.cc 格式
        const cipMatch = text.match(/IP.*?:\s*([\d.]+)/);
        if (cipMatch) return cipMatch[1];
        
        // 匹配 ip.cn 格式
        const ipcnMatch = text.match(/"ip":"([^"]+)"/);
        if (ipcnMatch) return ipcnMatch[1];
        
        // 匹配 163.com 格式
        const ip163 = text.match(/(\d+\.\d+\.\d+\.\d+)/);
        return ip163 ? ip163[0] : null;
    }

    // 状态更新方法
    updateStatus(type, text, statusClass) {
        const element = document.getElementById(`${type}-status`);
        element.className = statusClass;
        element.innerHTML = text;
    }

    updateClientInfo(ip, isError = false) {
        document.getElementById('client-ip').textContent = ip;
        document.getElementById('client-ip').className = isError ? 'error' : 'success';
        
        const type = ip.includes(':') ? 'IPv6' : 'IPv4';
        document.getElementById('connection-type').textContent = type;
        document.getElementById('connection-type').className = 'success';
    }
}

// 初始化检测器
window.addEventListener('load', () => {
    new NetworkDetector().init();
});
</script>
</body>
</html>